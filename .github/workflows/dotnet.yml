name: .NET 9 MAUI CI/CD

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  # ======================
  # Windows + Android Build
  # ======================
  build-windows-android:
    runs-on: windows-latest
    steps:
      # Checkout
      - uses: actions/checkout@v4

      # Setup .NET 9
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      # Cache NuGet
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: nuget-${{ runner.os }}-

      # Install MAUI & workloads
      - name: Install MAUI workloads
        run: dotnet workload install maui --ignore-failed-sources

      # Restore dependencies
      - name: Restore dependencies
        run: |
          dotnet workload restore
          dotnet restore /p:RuntimeIdentifier=win-x64

      # Build class libraries
      - name: Build Class Libraries
        run: dotnet build CheapGlyphForge.Core/CheapGlyphForge.Core.csproj -c Release

      # Run tests (if any)
      - name: Run Tests
        run: dotnet test --no-build --verbosity normal

      # Build Windows
      - name: Build Windows App
        run: dotnet publish CheapGlyphForge.MAUI/CheapGlyphForge.MAUI.csproj -f net9.0-windows10.0.19041.0 -r win-x64 -c Release --self-contained false

      # Build Android
      - name: Build Android App
        run: dotnet publish CheapGlyphForge.MAUI/CheapGlyphForge.MAUI.csproj -f net9.0-android -c Release

      # Upload artifacts
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: CheapGlyphForge.MAUI/bin/Release/net9.0-windows10.0.19041.0/win-x64

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: CheapGlyphForge.MAUI/bin/Release/net9.0-android

  # ======================
  # macOS: iOS + MacCatalyst Build
  # ======================
  build-ios-macos:
    runs-on: macos-latest
    steps:
      # Checkout
      - uses: actions/checkout@v4

      # Setup .NET 9
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      # Cache NuGet
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: nuget-${{ runner.os }}-

      # Install MAUI & Apple workloads
      - name: Install MAUI workloads
        run: dotnet workload install maui --ignore-failed-sources

      # Restore dependencies
      - name: Restore dependencies
        run: |
          dotnet workload restore
          dotnet restore /p:RuntimeIdentifier=maccatalyst-x64

      # Build Mac Catalyst
      - name: Build Mac Catalyst App
        run: dotnet publish CheapGlyphForge.MAUI/CheapGlyphForge.MAUI.csproj -f net9.0-maccatalyst -r maccatalyst-x64 -c Release

      # Build iOS (Simulator)
      - name: Build iOS App (Simulator)
        run: dotnet publish CheapGlyphForge.MAUI/CheapGlyphForge.MAUI.csproj -f net9.0-ios -r iossimulator-x64 -c Release

      # Upload artifacts
      - name: Upload Mac Catalyst Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: CheapGlyphForge.MAUI/bin/Release/net9.0-maccatalyst

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: CheapGlyphForge.MAUI/bin/Release/net9.0-ios
